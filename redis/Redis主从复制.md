# Redis主从复制

Redis的主从复制是Redis提供的多机功能中最基础的一个，它允许用户为存储着目标数据库的服务器创建出多个拥有相同数据库副本的服务器，其中存储目标数据库的服务叫`master server`,而存储数据库副本的服务器叫`slave server`。

对Redis来说，一个主服务其可以拥有多个从服务器，而从服务器本身也可以作为其他服务器的住服务器，它可以构建出类似树状的服务器结构。

<img title="" src="http://img.bakelu.cn/blog/redis%E5%A4%8D%E5%88%B6%E6%A0%91%E7%8A%B6%E7%BB%93%E6%9E%84.png" alt="" data-align="center">

默认情况下复制模式的主服务器既可以写也可以执行读操作，而从服务器只能进行读操作。Redis的复制功能有以下好处：

- 在性能方面，Redis的复制功能提高系统的读性能。因为客户端可以从master或者slave同时读取数据。

- 其次增加从服务器可以降低系统在遭受故障是丢失数据的可能性。如果只有一台主服务器有故障，那么整个服务将不可用。如果设置从服务器，那么即使主服务器宕机，从服务还能提供读的能力，数据丢失可能性也将降低。

- 如果在使用Redis的复制功能同时还加入Sentinel功能，用户可以为整个Redis系统提供高可用性。

### 如何将Redis设置成从服务器

Redis提供了3中方式用来将当前Redis设置成从服务器。

#### 客户端运行执行

该方式是通过`redis-cli`的方式连接到对应的Redis服务器之后，然后执行如下命令：

```
REPLICAOF ${host} ${port}
```

执行完成之后可以通过`ROLE`命令来查看当前节点的角色。如果在从服务器上运行，将显示出当前节点为`slave`；如果在主服务器上执行，将显示当前节点为`master`。

#### 启动时指定

在启动Redis时可以通过如下方式指定当前节点为从节点，其格式如下：

```shell
$ redis-server -- relicaof ${host} ${port}
```

该方式启动Redis后，Redis将变成从服务器。

#### 修改redis.conf配置文件

前面两种方式如果重启后需要再次执行或者增加启动选项比较麻烦，通常的做法是修改其配置文件，在配置文件中增加如下内容：

```
REPLICAOF ${host} ${port}
```

如果主服务器开启了密码校验，还需要在配置文件中增加如下配置：

```
masterauth {password}
```

其中`${password}`是主服务器的密码。

## 脱离主从

如果当前从服务器想脱离主服务器，形成单独节点可以执行下面的指令来实现脱离主服务，同时复制过来的数据并不会被删除。

```
REPLICAOF NO ONE
```

> 如果之前是使用配置文件的方式变成的从服务器，注意将配置文件中的相关内容删除或者注释，否则重启之后又会变从服务器。

## 数据同步

当用户将一个服务器设置为从服务器，主从服务器之间通过数据同步来让两个服务器的数据保持一致。

### 完整同步

当一个Redis服务器接受到`REPLICAOF`命令后，开始对另一个服务器进行复制，主服务器会执行下面的操作：

- 主服务器执行`BGSAVE`命令，生成一个`RDB`文件，并且使用缓存区将`BGSAVE`后的`写`命令缓存起来。

- 当`RDB`文件创建完毕之后，主服务器会通过网络将`RDB`文件传送给从服务器。

- 从服务器在接收完主服务器传送过来的`RDB`文件后，就会将`RDB`文件中的数据载入到内存中，这样就获得了执行`BGSAVE`之前的所有数据。

- 当从服务器完成`RDB`文件载入之后，主服务就会把之前缓存的`写`命令发送给从服务器执行

通过上面四步就完成主从服务器之间数据的完整同步。

> 如果主服务器在接受到`REPLICAOF`命令后，并不一定会创建`RDB`操作。如果之前已经完成了一次`RDB`创建操作，并且它的数据库在创建`RDB`文件之后并没有任何变化，那么主服务器会跳过该步骤。
> 
> 如果同时接受到多个从服务器同步请求，也不会从新创建`RDB`操作。

### 在线更新

在主从服务器执行完整的同步操作之后，它的数据就达到了一致性，但是这种一致性只是暂时的。每当主服务器执行了新的写命令之后，它的数据就会被改变。为了保证主从数据的一致性，这时就需要主从服务器进行数据同步，整个过程如下：

- 每当主服务器执行完一个写命令之后，它就会将相同的写命令发送给从服务器执行。

- 从服务器就收并执行从主服务发送过来的命令。

这个过程中，只要主从服务器一致保持连接，在主服务器上的更新操作就会不断的同步到从服务器中，使得主从服务器一直保持一致。

> 因为主服务器是执行完写命令后再将命令发送到从服务器，在从服务器还没执行完命令之前，主从服务器数据会出现短暂的不一致。如果要求强一直性，则可能需要程序直接去读取主服务器而不是从服务器。

### 部分同步

当主服务执行完写命令后因为故障下线，而写命令还没发送给从服务器。或者从服务器下线，再次上线发现主从服务器数据状态不一致时，这个时候就要进行部分同步，

在之前的老版本中，重新同步操作是直接进行完整同步来实现的，但是如果主从服务器只是短暂的下线导致数据不一致，这种方式非常的低效且浪费资源。为了解决这个问题，在后续的版本中，开始使用新的重新同步方式来替换老的方式，整个过程大致如下：

- 当一个Redis服务器成为另一个服务器的主服务器时，它会把每个被执行的写命令都记录到一个特定长度的先进先出队列中。

- 当断线的从服务器尝试重新连接主服务器的时候，主服务器将检查从服务器断线期间被执行的写命令是否仍然保存在队列里面。如果是，从服务器通过执行队列中未被执行的写命令就可以重新与主服务器数据保持一致，这样就避免了重新进行完整同步的麻烦。

- 如果从服务器缺失的那些命令已经不存在队列当中，那么主从服务器就就行一次完整的同步。

默认情况下，主服务器的这个队列的大小为1MB，用户可以根据自己的需求来设置，通过`repl-backlog-size`修改这个队列的大小。

## repl-diskless-sync

在主从服务器进行一次完整同步的时候，主服务器需要在本地创建`RDB`文件，然后通过网络将这个`RDB`文件传送给从服务器。但是如果主服务器所在的机器硬盘负载非常大或者性能不好时，那么创建`RDB`文件会导致主服务器性能受到影响，并且导致复制过程变慢。

为了解决这个问题，在新的版本中引入了无需磁盘的复制特性，当`repl-diskless-sync`设置为`yes`时，主服务在收到`REPLICAOF`命令后将不会再本地创建`RDB`文件，而是会fork出一个子线程，然后由子线程直接将数据通过网络写入到从服务器。这样就完成不在主服务器中生成`RDB`文件的情况下完成主从服务数据同步。

## 降低数据不一致出现的概率

当主从服务连接不稳定的时候，主从容易出现主从不一致的情况。在2.8之后的版本中增加了两个配置，用来减少主从数据不一致的概率。

```
min-replicas-max-lag <seconds>
min-replicas-to-write <numbers>
```

其中`min-replicas-max-lag`参数用来设置主从之间最后一次通信的间隔，`min-replicas-to-write`用来配置从服务器的最小节点数。如果该配置内容如下：

```
min-replicas-max-lag 60
min-replicas-to-write 2
```

这代表主服务器只有在拥有2个从服务器，并且从服务器与主服务器最后一次通信时间不超过60s的情况下，主服务器才会执行写命令。如果此时对主服务器进行写操作，将提示一下错误信息：

```
(error) NOREPLICAS Not enough good replicas to write.
```

## 从服务器的不可写性

默认情况下，当Redis节点变成从节点之后，那么从节点将无法写入数据。如果写入数据将报如下异常

```
(error) READONLY You can't write against a read only replica.
```

Redis之所以将从服务器默认设置成只读服务器，主要目的是为了保证主从数据的一致性。但是如果你想在临时在从服务器中存入部门数据，默认情况下是无法进行的。Redis提供了如下配置用来修改从服务器的读写功能：

```
replica-read-only <yes|no>
```
