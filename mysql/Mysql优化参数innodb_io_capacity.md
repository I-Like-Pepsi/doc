# Mysql优化参数innodb_io_capacity

## 背景

如果你的Mysql服务写入速度很慢，TPS很低但是数据库主机的I/O压力并不大，可能是因为```innodb_io_capacity```参数设置的不合理。关于这个参数还得从数据库的脏页说起。

## 数据更新

因为mysql的WAL机制更新数据时只更新了内存页和redo log日志，可能会出现内存页跟磁盘页数据不一致的情况，对于这种内存页我们称作```脏页```。当内存数据写入到磁盘后，内存页和磁盘上的数据页内容保持一致后我们称作```干净页```。

对于脏页最后总归是要刷新到磁盘中去的，但是会在什么时候刷到磁盘呢？

- 第一种场景就是redo log文件写满了。因为redo log写满了，此时WAL机制无法做到写内存并更新redo log了，此时就需要将部分脏页数据写入到磁盘，然后将redo log重置以供后续的写操作。

- 第二种场景就是当需要新的内存页而内存页不够时，此时就需要淘汰部分内存页，空出的内存页给别的数据页使用。如果淘汰的是脏页则需要将脏页数据写入到磁盘。

- 第三种就是系统空闲的时候，Mysql会将脏页刷到磁盘。

- 第四种场景就是数据库关闭的时候，Mysql需要将脏页数据写入到磁盘。

对于上面四种情况，我们需要关心的就是第一种和第二种，对于后续两种我们基本上不需要太关注。

### redo log写满

redo log写满了要刷脏页这种情况我们要避免。对于这种情况，Mysql服务就不能接受更新操作了，所有的更新操作都被堵住。如果从监控上来看，这个时候更新数会跌为0。关于redo log日志的大小我们可以通过下面两个参数来看。

```sql
show variables like 'innodb_log_files_in_group';
show variables like 'innodb_log_file_size';
```

redo log可以设置成一组文件，```innodb_log_files_in_group```这个参数指的就是这个组中文件的个数。```innodb_log_file_size```指的就是这个组中每个文件的大小。redo log实际大小就是```innodb_log_files_in_group * innodb_log_file_size```，这里面```innodb_log_file_size```的单位为字节，默认情况下一般每个文件大小为48M。

> 关于更多知识可以参考该文章：http://mysql.taobao.org/monthly/2015/05/01/

实际应该设置的大小这个得根据实际业务和场景来决定。

### 内存页不够用了

在实际的生产情况，内存页不够用了这种情景比较多。InnoDB用缓冲池（buffer pool）管理内存，对于缓冲池中的内存页一般有三种状态：

- 新的没有使用过的

- 使用了并且是干净的

- 使用了并且是脏页

对于长时间允许的mysql服务来说，新的没有使用过的情况还是比较少见，更多的情况是第二种和第三种混合，所以刷脏页也算是常态。如果刷脏页的太多，则会明显的影响性能。

## 设置合理的innodb_io_capacity参数

这个参数的作用是用来告诉InnoDB你的磁盘能力，这个值建议设置成磁盘的IOPS值。特别当我们Mysql是自己安装的，通常情况下我们不会去修改该值。默认情况下，Mysql设置的该值为**200**，如果你服务器的磁盘是SSD的话，该值就明显偏小了。如果该值偏小，Mysql认为刷脏页比较慢这样可能会造成脏页积累从而影响数据库性能。

关于如何测算你磁盘的IOPS值，我们可以使用fio工具，安装该工具后我们可以通过如下命令测试：

```shell
fio -filename=$filename -direct=1 -iodepth 1 -thread -rw=randrw -ioengine=psync -bs=16k -size=500M -numjobs=10 -runtime=10 -group_reporting -name=mytest 
```

其中```$filename```指的是需要测试的盘的data目录。

### innodb_flush_neighbors

在Mysql中还存在一个机制，如果在对一个数据页进行刷脏页时，会顺带看一下相邻的数据页时不是脏页。如果是它还会把相邻的这个脏页也刷掉，并且这个动作会一直执行下去。

如果你的服务器是机械硬盘，那么这个机制很有用，这样做可以减少随机IO。但是如果你的服务器是SSD的话，随机IO和顺序IO的差别并不是那么大，这个机制会造成你的sql响应时间无故的边长。

在innoDB中是通过```innodb_flush_neighbors```参数来控制着一行为的，在8.0以下的版本，该值默认为0即关闭了该行为，但是不是的话，该值默认为1。
