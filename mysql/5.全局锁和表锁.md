# 全局锁和表锁

## 全局锁

使用命令```Flush tables with read lock```(FTWRL)，该命令会将整个库处于只读状态，此时无法进行数据的增删改操作以及修改数据库表结构的相关操作。

全局锁的使用场景就是做全库备份逻辑备份。如果不加锁，备份的库不是一个逻辑时间点，备份时的视图是逻辑不一致的。

在使用mysqldump工具时，使用参数```–single-transaction```在导出数据之前会开启一个事务，来确保拿到的是一致性视图。而由于MVCC的支持，这个过程中数据库是可以正常更新的。

但是如果引擎不支持该隔离级别，或者引擎的隔离级别不是可重复读时，使用mysqldump得到的备份也是不正确的，所以还是需要改命令的存在。

同样mysql还可以使用```set global readonly=true```的方式使全库进入只读状态，但是不建议你这么操作。理由如下：

- 一些系统中，readonly的值会用来做其他逻辑。例如判断一个库是主库还是备库。

- 如果执行FTWRL命令之后由于客户端发生异常断开，那么Mysql会自动释放全局锁使整个库回到正常状态。而如果使用readonly的方式，如果客户端发生异常数据库会一直保持readonly状态。

## 表级锁

Mysql中表级锁有两种，一种是表锁，一种是元数据锁。

- 表锁的语法是```lock tables ... read/write```。与FTWRL相似，可以用```unlock tables```主动释放锁，也可以在客户端断开的时候自动释放。该命令会限制别的线程的读写外，还会限制本线程接下来的操作对象。例如执行```lock tables t1 read, t2 write```，则接下的来别的线程无法对t1进行写操作，对t2无法执行读写操作。本线程无法对其他表进行操作，同时对t1表也只能读。

- 另一类表级锁是DML(metadata lock)。MDL不需要显示使用，在访问一个表的时候会被自动加上。MDL的作用是保证读写的正确性。当对一个表做增删改查的操作的时候加DML读锁，当要对表结构做变更操作时，加DML写锁。
